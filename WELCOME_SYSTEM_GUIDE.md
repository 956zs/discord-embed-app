# æ­¡è¿è¨Šæ¯ç³»çµ±èˆ‡æˆå“¡çµ±è¨ˆåŠŸèƒ½æŒ‡å—

## åŠŸèƒ½æ¦‚è¿°

æ­¤ç³»çµ±æä¾›ä»¥ä¸‹åŠŸèƒ½ï¼š

### 1. æ­¡è¿è¨Šæ¯ç³»çµ±
- âœ… è‡ªå®šç¾©æ­¡è¿è¨Šæ¯ï¼ˆæ”¯æ´è®Šæ•¸ï¼‰
- âœ… æ”¯æ´ Embed æ ¼å¼èˆ‡ç´”æ–‡å­—æ ¼å¼
- âœ… è‡ªå®šç¾©é »é“
- âœ… ç§è¨Šæ­¡è¿è¨Šæ¯
- âœ… è‡ªå‹•çµ¦äºˆèº«åˆ†çµ„
- âœ… ç®¡ç†å“¡é¢æ¿é…ç½®

### 2. æˆå“¡çµ±è¨ˆåŠŸèƒ½
- âœ… è¨˜éŒ„æˆå“¡åŠ å…¥/é›¢é–‹äº‹ä»¶
- âœ… æ¯æ—¥æˆå“¡æ•¸çµ±è¨ˆ
- âœ… æˆå“¡è®ŠåŒ–è¶¨å‹¢åœ–è¡¨
- âœ… ä»Šæ—¥/æœ¬æœˆçµ±è¨ˆæ‘˜è¦
- âœ… å¢é•·ç‡åˆ†æ

## å®‰è£æ­¥é©Ÿ

### 1. æ›´æ–°è³‡æ–™åº«æ¶æ§‹

åŸ·è¡Œè³‡æ–™åº«é·ç§»è…³æœ¬ï¼š

```bash
psql -h $DB_HOST -p $DB_PORT -U $DB_USER -d $DB_NAME -f bot/database/add_welcome_and_members.sql
```

é€™æœƒå‰µå»ºä»¥ä¸‹è¡¨ï¼š
- `welcome_config` - æ­¡è¿è¨Šæ¯é…ç½®
- `member_events` - æˆå“¡è®ŠåŒ–äº‹ä»¶è¨˜éŒ„
- `daily_member_stats` - æ¯æ—¥æˆå“¡çµ±è¨ˆ

### 2. é‡å•Ÿæ©Ÿå™¨äºº

```bash
pm2 restart discord-bot
# æˆ–
cd bot && node index.js
```

### 3. é‡å•Ÿä¼ºæœå™¨

```bash
pm2 restart discord-server
# æˆ–
cd server && node index.js
```

## è³‡æ–™åº«æ¶æ§‹

### welcome_config è¡¨

| æ¬„ä½ | é¡å‹ | èªªæ˜ |
|------|------|------|
| guild_id | VARCHAR(20) | ä¼ºæœå™¨ IDï¼ˆä¸»éµï¼‰|
| enabled | BOOLEAN | æ˜¯å¦å•Ÿç”¨ |
| channel_id | VARCHAR(20) | æ­¡è¿è¨Šæ¯é »é“ ID |
| message_template | TEXT | è¨Šæ¯æ¨¡æ¿ |
| embed_enabled | BOOLEAN | æ˜¯å¦ä½¿ç”¨ Embed |
| embed_color | VARCHAR(7) | Embed é¡è‰² |
| embed_title | TEXT | Embed æ¨™é¡Œ |
| embed_description | TEXT | Embed æè¿° |
| embed_footer | TEXT | Embed é è…³ |
| embed_thumbnail | BOOLEAN | æ˜¯å¦é¡¯ç¤ºç”¨æˆ¶é ­åƒ |
| dm_enabled | BOOLEAN | æ˜¯å¦ç™¼é€ç§è¨Š |
| dm_message | TEXT | ç§è¨Šå…§å®¹ |
| autorole_enabled | BOOLEAN | æ˜¯å¦è‡ªå‹•çµ¦äºˆèº«åˆ†çµ„ |
| autorole_ids | TEXT[] | èº«åˆ†çµ„ ID åˆ—è¡¨ |

### member_events è¡¨

| æ¬„ä½ | é¡å‹ | èªªæ˜ |
|------|------|------|
| id | BIGSERIAL | ä¸»éµ |
| guild_id | VARCHAR(20) | ä¼ºæœå™¨ ID |
| user_id | VARCHAR(20) | ç”¨æˆ¶ ID |
| username | VARCHAR(100) | ç”¨æˆ¶åç¨± |
| event_type | VARCHAR(20) | äº‹ä»¶é¡å‹ï¼ˆjoin/leaveï¼‰|
| member_count | INTEGER | äº‹ä»¶ç™¼ç”Ÿæ™‚çš„æˆå“¡ç¸½æ•¸ |
| account_created_at | TIMESTAMP | å¸³è™Ÿå‰µå»ºæ™‚é–“ |
| join_position | INTEGER | åŠ å…¥é †åºï¼ˆç¬¬å¹¾ä½æˆå“¡ï¼‰|
| created_at | TIMESTAMP | äº‹ä»¶æ™‚é–“ |

### daily_member_stats è¡¨

| æ¬„ä½ | é¡å‹ | èªªæ˜ |
|------|------|------|
| id | SERIAL | ä¸»éµ |
| guild_id | VARCHAR(20) | ä¼ºæœå™¨ ID |
| stat_date | DATE | çµ±è¨ˆæ—¥æœŸ |
| member_count_start | INTEGER | ç•¶å¤©é–‹å§‹æ™‚çš„æˆå“¡æ•¸ |
| member_count_end | INTEGER | ç•¶å¤©çµæŸæ™‚çš„æˆå“¡æ•¸ |
| joins_count | INTEGER | ç•¶å¤©åŠ å…¥äººæ•¸ |
| leaves_count | INTEGER | ç•¶å¤©é›¢é–‹äººæ•¸ |
| net_change | INTEGER | æ·¨è®ŠåŒ– |

## API ç«¯é»

### æ­¡è¿è¨Šæ¯é…ç½®

#### ç²å–é…ç½®
```
GET /api/welcome/:guildId/config
```

#### æ›´æ–°é…ç½®
```
PUT /api/welcome/:guildId/config
Content-Type: application/json

{
  "enabled": true,
  "channel_id": "123456789",
  "message_template": "æ­¡è¿ {user} åŠ å…¥ {server}ï¼",
  "embed_enabled": true,
  "embed_color": "#5865F2",
  "embed_title": "æ­¡è¿åŠ å…¥ï¼",
  "embed_description": "æ­¡è¿ {user} åŠ å…¥ {server}ï¼\nä½ æ˜¯ç¬¬ {memberCount} ä½æˆå“¡ï¼",
  "embed_footer": "äº«å—ä½ çš„æ—…ç¨‹ï¼",
  "embed_thumbnail": true,
  "dm_enabled": false,
  "dm_message": null,
  "autorole_enabled": false,
  "autorole_ids": []
}
```

### æˆå“¡çµ±è¨ˆ

#### ç²å–çµ±è¨ˆæ•¸æ“š
```
GET /api/welcome/:guildId/stats?days=30
```

è¿”å›æ ¼å¼ï¼š
```json
[
  {
    "date": "2024-01-01",
    "joins": 5,
    "leaves": 2,
    "memberCount": 103,
    "netChange": 3
  }
]
```

#### ç²å–æ‘˜è¦
```
GET /api/welcome/:guildId/summary
```

è¿”å›æ ¼å¼ï¼š
```json
{
  "current": {
    "memberCount": 150
  },
  "today": {
    "joins": 3,
    "leaves": 1,
    "netChange": 2
  },
  "month": {
    "joins": 45,
    "leaves": 20,
    "netChange": 25
  }
}
```

#### ç²å–äº‹ä»¶åˆ—è¡¨
```
GET /api/welcome/:guildId/events?type=join&limit=50
```

## è¨Šæ¯æ¨¡æ¿è®Šæ•¸

åœ¨æ­¡è¿è¨Šæ¯ä¸­å¯ä»¥ä½¿ç”¨ä»¥ä¸‹è®Šæ•¸ï¼š

| è®Šæ•¸ | èªªæ˜ | ç¯„ä¾‹ |
|------|------|------|
| `{user}` | ç”¨æˆ¶æåŠï¼ˆ@ç”¨æˆ¶ï¼‰| @å°æ˜ |
| `{username}` | ç”¨æˆ¶åç¨± | å°æ˜ |
| `{tag}` | å®Œæ•´ç”¨æˆ¶æ¨™ç±¤ | å°æ˜#1234 |
| `{server}` | ä¼ºæœå™¨åç¨± | æˆ‘çš„ç¤¾ç¾¤ |
| `{memberCount}` | ç•¶å‰æˆå“¡æ•¸ | 150 |
| `{userId}` | ç”¨æˆ¶ ID | 123456789 |
| `{guildId}` | ä¼ºæœå™¨ ID | 987654321 |

## ç®¡ç†å“¡é¢æ¿ä½¿ç”¨

### 1. è¨ªå•æ­¡è¿è¨Šæ¯è¨­å®š

åœ¨ç®¡ç†å“¡é¢æ¿ä¸­ï¼Œå°èˆªåˆ°ã€Œæ­¡è¿è¨Šæ¯ã€æ¨™ç±¤ï¼š

```
/admin â†’ æ­¡è¿è¨Šæ¯
```

### 2. é…ç½®æ­¡è¿è¨Šæ¯

1. **å•Ÿç”¨åŠŸèƒ½**ï¼šé–‹å•Ÿã€Œå•Ÿç”¨æ­¡è¿è¨Šæ¯ã€é–‹é—œ
2. **é¸æ“‡é »é“**ï¼šå¾ä¸‹æ‹‰é¸å–®é¸æ“‡ç™¼é€æ­¡è¿è¨Šæ¯çš„é »é“
3. **é…ç½®è¨Šæ¯**ï¼š
   - é¸æ“‡ä½¿ç”¨ Embed æˆ–ç´”æ–‡å­—æ ¼å¼
   - å¡«å¯«è¨Šæ¯å…§å®¹ï¼Œä½¿ç”¨è®Šæ•¸è‡ªå®šç¾©
   - è¨­å®š Embed é¡è‰²ã€æ¨™é¡Œã€æè¿°ç­‰
4. **ç§è¨Šè¨­å®š**ï¼ˆé¸å¡«ï¼‰ï¼š
   - å•Ÿç”¨ç§è¨ŠåŠŸèƒ½
   - å¡«å¯«ç§è¨Šå…§å®¹
5. **è‡ªå‹•èº«åˆ†çµ„**ï¼ˆé¸å¡«ï¼‰ï¼š
   - å•Ÿç”¨è‡ªå‹•èº«åˆ†çµ„
   - é¸æ“‡è¦çµ¦äºˆçš„èº«åˆ†çµ„
6. **å„²å­˜é…ç½®**ï¼šé»æ“Šã€Œå„²å­˜é…ç½®ã€æŒ‰éˆ•

### 3. æŸ¥çœ‹æˆå“¡çµ±è¨ˆ

åœ¨ç®¡ç†å“¡é¢æ¿ä¸­ï¼Œå°èˆªåˆ°ã€Œæˆå“¡çµ±è¨ˆã€æ¨™ç±¤ï¼š

```
/admin â†’ æˆå“¡çµ±è¨ˆ
```

åŠŸèƒ½ï¼š
- æŸ¥çœ‹ç•¶å‰æˆå“¡æ•¸
- æŸ¥çœ‹ä»Šæ—¥/æœ¬æœˆè®ŠåŒ–
- æŸ¥çœ‹å¢é•·ç‡
- æŸ¥çœ‹æˆå“¡è®ŠåŒ–è¶¨å‹¢åœ–è¡¨
- åˆ‡æ›ä¸åŒæ™‚é–“ç¯„åœï¼ˆ7å¤©/30å¤©/90å¤©/ä¸€å¹´ï¼‰

## æ©Ÿå™¨äººæ¬Šé™éœ€æ±‚

ç¢ºä¿æ©Ÿå™¨äººæ“æœ‰ä»¥ä¸‹æ¬Šé™ï¼š

- âœ… `Manage Roles` - çµ¦äºˆèº«åˆ†çµ„
- âœ… `Send Messages` - ç™¼é€æ­¡è¿è¨Šæ¯
- âœ… `Embed Links` - ç™¼é€ Embed
- âœ… `View Channel` - æŸ¥çœ‹é »é“
- âœ… `Read Message History` - è®€å–è¨Šæ¯æ­·å²

## ç¯„ä¾‹é…ç½®

### ç¯„ä¾‹ 1ï¼šç°¡å–®æ­¡è¿è¨Šæ¯

```json
{
  "enabled": true,
  "channel_id": "123456789",
  "message_template": "ğŸ‘‹ æ­¡è¿ {user} åŠ å…¥ {server}ï¼",
  "embed_enabled": false
}
```

### ç¯„ä¾‹ 2ï¼šç²¾ç¾ Embed æ­¡è¿è¨Šæ¯

```json
{
  "enabled": true,
  "channel_id": "123456789",
  "embed_enabled": true,
  "embed_color": "#5865F2",
  "embed_title": "ğŸ‰ æ­¡è¿åŠ å…¥ï¼",
  "embed_description": "å—¨ {user}ï¼\n\næ­¡è¿ä¾†åˆ° {server}ï¼\nä½ æ˜¯æˆ‘å€‘çš„ç¬¬ {memberCount} ä½æˆå“¡ï¼\n\nè«‹å…ˆé–±è®€è¦å‰‡é »é“ï¼Œç„¶å¾Œé–‹å§‹èŠå¤©å§ï¼",
  "embed_footer": "äº«å—ä½ åœ¨é€™è£¡çš„æ™‚å…‰ï¼",
  "embed_thumbnail": true
}
```

### ç¯„ä¾‹ 3ï¼šå®Œæ•´é…ç½®ï¼ˆå«ç§è¨Šå’Œè‡ªå‹•èº«åˆ†çµ„ï¼‰

```json
{
  "enabled": true,
  "channel_id": "123456789",
  "embed_enabled": true,
  "embed_color": "#5865F2",
  "embed_title": "ğŸ‰ æ­¡è¿åŠ å…¥æˆ‘å€‘çš„ç¤¾ç¾¤ï¼",
  "embed_description": "å“ˆå›‰ {user}ï¼\n\næ­¡è¿ä¾†åˆ° {server}ï¼ä½ æ˜¯ç¬¬ {memberCount} ä½æˆå“¡ï¼",
  "embed_footer": "ç¥ä½ ç©å¾—é–‹å¿ƒï¼",
  "embed_thumbnail": true,
  "dm_enabled": true,
  "dm_message": "ğŸ‘‹ å—¨ï¼æ„Ÿè¬ä½ åŠ å…¥ {server}ï¼\n\nè«‹è¨˜å¾—é–±è®€ä¼ºæœå™¨è¦å‰‡ï¼Œæœ‰ä»»ä½•å•é¡Œéƒ½å¯ä»¥è©¢å•ç®¡ç†å“¡ï¼",
  "autorole_enabled": true,
  "autorole_ids": ["987654321", "876543210"]
}
```

## æ•…éšœæ’é™¤

### å•é¡Œï¼šæ­¡è¿è¨Šæ¯æ²’æœ‰ç™¼é€

**æª¢æŸ¥é …ç›®ï¼š**
1. âœ… é…ç½®ä¸­çš„ `enabled` æ˜¯å¦ç‚º `true`
2. âœ… `channel_id` æ˜¯å¦æ­£ç¢º
3. âœ… æ©Ÿå™¨äººæ˜¯å¦æœ‰è©²é »é“çš„ç™¼é€è¨Šæ¯æ¬Šé™
4. âœ… æ©Ÿå™¨äººæ˜¯å¦å·²é‡å•Ÿ
5. âœ… æª¢æŸ¥æ©Ÿå™¨äººæ—¥èªŒæ˜¯å¦æœ‰éŒ¯èª¤

### å•é¡Œï¼šç§è¨Šç„¡æ³•ç™¼é€

**åŸå› ï¼š**
- ç”¨æˆ¶é—œé–‰äº†é™Œç”Ÿäººç§è¨Š
- é€™æ˜¯æ­£å¸¸è¡Œç‚ºï¼Œæ©Ÿå™¨äººæœƒè¨˜éŒ„éŒ¯èª¤ä½†ä¸æœƒå½±éŸ¿å…¶ä»–åŠŸèƒ½

### å•é¡Œï¼šè‡ªå‹•èº«åˆ†çµ„ç„¡æ³•çµ¦äºˆ

**æª¢æŸ¥é …ç›®ï¼š**
1. âœ… æ©Ÿå™¨äººæ˜¯å¦æœ‰ `Manage Roles` æ¬Šé™
2. âœ… æ©Ÿå™¨äººçš„èº«åˆ†çµ„æ˜¯å¦é«˜æ–¼è¦çµ¦äºˆçš„èº«åˆ†çµ„
3. âœ… èº«åˆ†çµ„ ID æ˜¯å¦æ­£ç¢º

### å•é¡Œï¼šçµ±è¨ˆæ•¸æ“šä¸æº–ç¢º

**è§£æ±ºæ–¹æ¡ˆï¼š**
1. ç¢ºèªè³‡æ–™åº«å·²æ›´æ–°
2. é‡å•Ÿæ©Ÿå™¨äººä»¥é–‹å§‹è¨˜éŒ„æ–°äº‹ä»¶
3. æ­·å²æ•¸æ“šç„¡æ³•è¿½æº¯ï¼Œåªèƒ½è¨˜éŒ„å¾ç¾åœ¨é–‹å§‹çš„äº‹ä»¶

## å®Œæˆï¼

ç¾åœ¨ä½ çš„ Discord æ©Ÿå™¨äººå·²ç¶“å…·å‚™ï¼š
- âœ… å®Œæ•´çš„æ­¡è¿è¨Šæ¯ç³»çµ±
- âœ… æˆå“¡çµ±è¨ˆèˆ‡åˆ†æåŠŸèƒ½
- âœ… è¦–è¦ºåŒ–ç®¡ç†å“¡é¢æ¿

æ‰€æœ‰åŠŸèƒ½éƒ½å¯ä»¥é€šéç¶²é ç®¡ç†å“¡é¢æ¿é€²è¡Œé…ç½®ï¼
