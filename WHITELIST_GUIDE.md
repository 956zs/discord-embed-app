# 伺服器白名單設定指南

本指南說明如何設定伺服器白名單，限制只有特定的 Discord 伺服器可以使用統計功能。

## 為什麼需要白名單？

- 🔒 **控制訪問** - 只允許授權的伺服器使用
- 💰 **節省資源** - 減少不必要的數據收集和處理
- 🛡️ **安全性** - 防止未授權的伺服器濫用 API
- 📊 **專注數據** - 只收集你關心的伺服器數據

## 快速設定

### 1. 獲取伺服器 ID

在 Discord 中：
1. 開啟「開發者模式」（設定 → 進階 → 開發者模式）
2. 右鍵點擊伺服器圖標
3. 選擇「複製伺服器 ID」

### 2. 配置環境變數

編輯 `.env` 文件：

```env
# 單個伺服器
ALLOWED_GUILD_IDS=123456789012345678

# 多個伺服器（用逗號分隔）
ALLOWED_GUILD_IDS=123456789012345678,987654321098765432,555666777888999000

# 允許所有伺服器（留空，不推薦用於生產環境）
ALLOWED_GUILD_IDS=
```

### 3. 重啟伺服器

```bash
# 停止當前伺服器（Ctrl+C）
# 重新啟動
npm run server
```

## 白名單行為

### 啟用白名單時
- ✅ 白名單中的伺服器可以正常訪問所有統計功能
- ❌ 其他伺服器會收到 403 錯誤：「此伺服器未被授權使用統計功能」

### 未設定白名單時
- ⚠️ 允許所有伺服器訪問（開發模式）
- 控制台會顯示警告訊息

## 檢查白名單狀態

### 方法 1：查看啟動日誌

啟動伺服器時會顯示：

```
🚀 伺服器運行在 http://localhost:3001
🔒 白名單已啟用，允許 2 個伺服器
   伺服器 ID: 123456789012345678, 987654321098765432
```

或

```
🚀 伺服器運行在 http://localhost:3001
⚠️  白名單未設定，允許所有伺服器訪問
   建議在 .env 中設定 ALLOWED_GUILD_IDS
```

### 方法 2：API 端點

訪問管理端點查看白名單狀態：

```bash
curl http://localhost:3001/api/admin/whitelist
```

回應範例：

```json
{
  "enabled": true,
  "count": 2,
  "guilds": [
    "123456789012345678",
    "987654321098765432"
  ]
}
```

## 測試白名單

### 測試允許的伺服器

```bash
# 替換為你白名單中的伺服器 ID
curl http://localhost:3001/api/stats/server/123456789012345678
```

應該返回伺服器統計數據。

### 測試被拒絕的伺服器

```bash
# 使用不在白名單中的伺服器 ID
curl http://localhost:3001/api/stats/server/999999999999999999
```

應該返回：

```json
{
  "error": "此伺服器未被授權使用統計功能",
  "message": "請聯繫管理員將您的伺服器加入白名單"
}
```

## 動態管理白名單

### 添加新伺服器

1. 編輯 `.env` 文件
2. 在 `ALLOWED_GUILD_IDS` 中添加新的伺服器 ID
3. 重啟伺服器

```env
# 添加前
ALLOWED_GUILD_IDS=123456789012345678

# 添加後
ALLOWED_GUILD_IDS=123456789012345678,新的伺服器ID
```

### 移除伺服器

1. 編輯 `.env` 文件
2. 從 `ALLOWED_GUILD_IDS` 中移除伺服器 ID
3. 重啟伺服器

## 前端處理

前端會自動處理白名單錯誤：

```typescript
// 在 Dashboard.tsx 中
try {
  const response = await axios.get(`${API_URL}/api/stats/server/${guildId}`);
  setServerStats(response.data);
} catch (error) {
  if (error.response?.status === 403) {
    // 顯示「此伺服器未被授權」訊息
    console.error('伺服器未在白名單中');
  }
}
```

## 生產環境建議

### 1. 必須設定白名單

```env
# ❌ 不要在生產環境留空
ALLOWED_GUILD_IDS=

# ✅ 明確指定允許的伺服器
ALLOWED_GUILD_IDS=123456789012345678,987654321098765432
```

### 2. 定期審查

- 定期檢查白名單中的伺服器
- 移除不再需要的伺服器
- 記錄添加/移除的原因

### 3. 監控訪問

查看日誌中的訪問記錄：

```
✅ 允許訪問: 伺服器 123456789012345678
🚫 拒絕訪問: 伺服器 999999999999999999 不在白名單中
```

### 4. 備份配置

定期備份 `.env` 文件（注意不要提交到 Git）

## 常見問題

### Q: 如何找到我的伺服器 ID？
A: 在 Discord 中開啟開發者模式，右鍵點擊伺服器圖標，選擇「複製伺服器 ID」。

### Q: 可以動態添加伺服器嗎？
A: 目前需要編輯 `.env` 文件並重啟伺服器。未來可以實現動態管理功能。

### Q: 白名單會影響 Bot 加入伺服器嗎？
A: 不會。Bot 仍然可以加入任何伺服器，但只有白名單中的伺服器可以使用統計功能。

### Q: 如何臨時禁用白名單？
A: 將 `ALLOWED_GUILD_IDS` 設為空值並重啟伺服器。

### Q: 白名單檢查會影響性能嗎？
A: 不會。白名單檢查非常快速，對性能影響可忽略不計。

## 進階功能

### 自動發現伺服器 ID

如果你不確定伺服器 ID，可以讓 Bot 列出所有已加入的伺服器：

```javascript
// 在 server/index.js 中添加
client.on('ready', () => {
  console.log('Bot 已加入的伺服器:');
  client.guilds.cache.forEach(guild => {
    console.log(`  - ${guild.name} (ID: ${guild.id})`);
  });
});
```

### 基於角色的訪問控制

未來可以實現更細緻的權限控制：

```javascript
// 範例：只允許有特定角色的用戶訪問
const hasAdminRole = member.roles.cache.some(role => role.name === 'Admin');
```

## 總結

白名單功能讓你可以：
- ✅ 控制哪些伺服器可以使用統計功能
- ✅ 節省資源和成本
- ✅ 提高安全性
- ✅ 專注於重要的數據

記得在生產環境中**必須設定白名單**！
